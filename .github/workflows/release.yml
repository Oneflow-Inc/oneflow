name: Release

on:
  schedule:
    # beijing: 2 am.
    # utc: 6 pm.
    - cron:  '0 18 * * *'
  workflow_dispatch:
    inputs:
      python_version:
        description: 'python_version'
        default: '3.5,3.6,3.7,3.8'
        required: false
      extra_flags:
        description: 'flags like --xla'
        default: ''
        required: false
jobs:
  staging_release:
    name: Staging Release
    timeout-minutes: 1200
    runs-on: [self-hosted, linux, release]
    continue-on-error: true
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        cuda_version: [10.0, 10.1, 10.2, 11.0, 11.1]
    steps:
    - name: Fix permissions
      run: |
        docker run --rm -v $PWD:/p -w /p busybox chmod -R o+w .
    - uses: actions/checkout@v2
    - name: Set environment variables
      env:
        input_cuda_version: ${{ github.event.inputs.cuda_version }}
        matrix_cuda_version: ${{matrix.cuda_version }}
        python_version: ${{ github.event.inputs.python_version }}
        extra_flags: ${{ github.event.inputs.extra_flags }}
      run: |
        set -x
        cuda_version=${matrix_cuda_version}
        if [ -z "$cuda_version" ]
        then
          echo "cuda_version empty"
          exit 1
        fi
        python_version=${python_version:-"3.5,3.6,3.7,3.8"}
        echo "cuda_version=${cuda_version}" >> $GITHUB_ENV
        echo "python_version=${python_version}" >> $GITHUB_ENV

        tmp_dir=$HOME/ci-tmp-rel
        echo "ci_tmp_dir=${tmp_dir}" >> $GITHUB_ENV
        echo "wheelhouse_dir=${tmp_dir}/wheelhouse" >> $GITHUB_ENV

        git_hash=$(git rev-parse --short "$GITHUB_SHA")
        git_branch=${GITHUB_REF##*/}
        oss_dir=${git_branch}/${git_hash}
        echo "oss_dir=${oss_dir}" >> $GITHUB_ENV
        echo "git_branch=${git_branch}" >> $GITHUB_ENV
    - name: Build OneFlow
      uses: ./.github/actions/whl
      with:
        tmp_dir: ${ci_tmp_dir}
        cuda_version: ${cuda_version}
        python_version: ${python_version}
        extra_flags: ${extra_flags}
    - name: Upload wheel
      uses: ./.github/actions/upload_oss
      with:
        src_path: ${wheelhouse_dir}
        oss_dst_path: oss://oneflow-staging/${oss_dir}
        oss_access_key_id: ${{ secrets.OSS_ACCESS_KEY_ID }}
        oss_access_key_secret: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
    - name: Update pip index
      env:
        OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
        OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
      run: |
        python3 -m pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
        python3 -m pip install oss2 beautifulsoup4 --user
        python3 tools/create_pip_index.py --dir_key ${oss_dir} -b oneflow-staging --index_key=${git_branch}/pip.index.html
    - name: Update API docs
      if: github.ref == 'refs/heads/master'
      env:
        READTHEDOCS_TOKEN: ${{ secrets.READTHEDOCS_TOKEN }}
      run: |
        curl -X POST -d "branches=master" -d "token=${READTHEDOCS_TOKEN}"  https://readthedocs.org/api/v2/webhook/oneflow/135376/
  pack_src:
    name: Pack source code
    runs-on: ubuntu-18.04
    steps:
    - uses: actions/checkout@v2
    - name: Pack OneFlow source code
      if: github.ref == 'refs/heads/master'
      env:
        OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
        OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
      run: |
        git reset --hard
        git clean -f
        git archive --format zip HEAD > oneflow-src.zip
        curl http://gosspublic.alicdn.com/ossutil/1.6.19/ossutil64 -o $HOME/ossutil64
        chmod 755 $HOME/ossutil64
        $HOME/ossutil64 config -e oss-cn-beijing.aliyuncs.com -i ${OSS_ACCESS_KEY_ID} -k ${OSS_ACCESS_KEY_SECRET}  -L EN -c $HOME/.ossutilconfig
        $HOME/ossutil64 cp --update oneflow-src.zip oss://oneflow-public/oneflow-src.zip
