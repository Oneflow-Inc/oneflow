name: Build and Test CI
on:
  pull_request:
    types: [review_requested]
    branches:
      - "*"
  workflow_dispatch:
    inputs:
      placeholder:
        description: "placeholder, no effect"
        required: false
jobs:
  set-initial-variables:
    name: Set initial variables
    if: ${{ github.repository_owner == 'Oneflow-Inc' }}
    runs-on: ubuntu-20.04
    outputs:
      build_matrix: ${{ steps.generating.outputs.build_matrix }}
      test_matrix: ${{ steps.generating.outputs.test_matrix }}
    steps:
      - name: Clone pytorch/pytorch
        uses: actions/checkout@v2
      - name: Generating variables
        id: generating
        run: |
          python3 -m pip install -r .github/scripts/requirements.txt --user
          python3 .github/scripts/set_initial_variables.py --labels "${{ join(github.event.pull_request.labels.*.name, ', ') }}" --out initial-variables.json
      - name: Print initial-variables.json
        run: |
          cat initial-variables.json
      - name: Upload initial-variables.json
        uses: actions/upload-artifact@v2
        with:
          name: initial-variables.json
          path: initial-variables.json

  cancel_previous:
    name: Cancel previous runs
    runs-on: ubuntu-latest
    steps:
      - name: Cancel previous runs of outdated commit
        uses: styfle/cancel-workflow-action@0.9.0
        with:
          access_token: ${{ github.token }}
          all_but_latest: true

  mirror_third_party:
    name: Mirror third party dependencies
    runs-on: ubuntu-18.04
    if: github.event.pull_request.draft == false && github.base_ref == 'master' && contains(github.event.pull_request.requested_reviewers.*.login, 'oneflow-ci-bot')
    steps:
      - uses: actions/checkout@v2
      - name: Mirror dependencies to aliyun
        env:
          OSS_ACCESS_KEY_ID: ${{ secrets.OSS_ACCESS_KEY_ID }}
          OSS_ACCESS_KEY_SECRET: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
        run: |
          set -x
          if [ -z "$OSS_ACCESS_KEY_ID" ]
          then
            exit 0
          fi
          python3 -m pip install -U pip setuptools wheel
          python3 -m pip install oss2
          python3 tools/package_mirror.py -i cmake

  check_license_and_format:
    name: License and format
    runs-on: ubuntu-18.04
    if: github.event.pull_request.draft == false && contains(github.event.pull_request.requested_reviewers.*.login, 'oneflow-ci-bot')
    steps:
      - uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{github.event.pull_request.head.repo.full_name}}
      - name: Check license
        id: license_check
        run: |
          python3 ci/check/run_license_format.py -i oneflow -c
          python3 ci/check/run_license_format.py -i python -c
      - name: Add license
        id: license_fmt
        if: ${{ failure() }}
        run: |
          python3 ci/check/run_license_format.py -i oneflow --fix
          python3 ci/check/run_license_format.py -i python --fix
      - name: Check C++/CUDA format
        id: cpp_check
        run: |
          python3 ci/check/run_clang_format.py --clang_format_binary clang-format --source_dir oneflow
      - name: Run C++/CUDA format
        id: cpp_fmt
        if: ${{ failure() }}
        run: |
          python3 ci/check/run_clang_format.py --clang_format_binary clang-format --source_dir oneflow --fix
      - name: Check Python format
        id: py_check
        run: |
          python3 -m pip install black==19.10b0
          python3 ci/check/run_py_format.py --source_dir $PWD
      - name: Run Python Format
        id: py_fmt
        if: ${{ failure() }}
        run: |
          python3 -m pip install black==19.10b0
          python3 ci/check/run_py_format.py --source_dir $PWD --fix
      - name: Git push
        id: git_push
        if: ${{ failure() }}
        run: |
          git config --global user.email "ci-bot@oneflow.org"
          git config --global user.name "oneflow-ci-bot"
          git add -u
          git commit -m "auto format by CI"
          git push
      - name: Please request CI again
        if: ${{ failure() }}
        run: |
          exit 1
      - name: Check source code (prevent creating files at wrong places)
        run: |
          python3 tools/check_src.py

  wait_for_gpu_slot:
    name: Wait for GPU slots
    runs-on: [self-hosted, scheduler]
    needs: [build]
    if: github.event.pull_request.draft == false && github.base_ref == 'master' && contains(github.event.pull_request.requested_reviewers.*.login, 'oneflow-ci-bot')
    continue-on-error: true
    steps:
      - name: Check if secrets accessible
        env:
          CI_PERSONAL_ACCESS_TOKEN: ${{ secrets.CI_PERSONAL_ACCESS_TOKEN }}
        run: |
          set -x
          if [ -z "$CI_PERSONAL_ACCESS_TOKEN" ]
          then
            exit 0
          fi
          echo "is_secrets_accessible=1" >> $GITHUB_ENV
      - uses: Oneflow-Inc/gh-action-scheduler-v2@1e45bd715c873bc3a14a87ddaf494f9b686137de
        name: Wait for GPU slot
        if: env.is_secrets_accessible == '1'
        timeout-minutes: 45
        env:
          CI_PERSONAL_ACCESS_TOKEN: ${{ secrets.CI_PERSONAL_ACCESS_TOKEN }}

  changed_files:
    name: "Changed files"
    runs-on: ubuntu-latest
    outputs:
      should_run_single_client_tests: ${{ steps.changes.outputs.should_run_single_client_tests }}
    steps:
      - name: Checkout OneFlow
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Set extra args
        if: contains(github.event.pull_request.labels.*.name, 'need-single-client-tests')
        run: |
          echo "extra_args_from_labels=--need_single_client_tests" >> $GITHUB_ENV
      - name: Find changes
        id: changes
        run: |
          python3 tools/flags_from_git_diff.py --base ${{ github.event.pull_request.base.sha }} --head ${{ github.sha }} ${{ env.extra_args_from_labels }}
      - name: Will run single client tests
        if: steps.changes.outputs.should_run_single_client_tests == '1'
        run: |
          echo "yes"
  build-cuda:
    name: Build
    needs:
      [
        set-initial-variables,
        check_license_and_format,
        mirror_third_party,
        cancel_previous,
        changed_files,
      ]
    continue-on-error: ${{ matrix.allow_fail }}
    runs-on: ${{ matrix.os }}
    if: github.event.pull_request.draft == false && github.base_ref == 'master' && contains(github.event.pull_request.requested_reviewers.*.login, 'oneflow-ci-bot') && contains(github.event.pull_request.labels.*.name, 'fmt-only') == false
    outputs:
      pip-index-url: ${{ steps.build-oneflow.outputs.pip-index-url }}
    steps:
      - name: Fix permissions
        run: |
          docker run --rm -v $PWD:/p -w /p busybox chmod -R o+w .
      - name: Checkout OneFlow source code
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Build OneFlow
        id: build-oneflow
        uses: Oneflow-Inc/get-oneflow@v1
        if: ${{ matrix.oneflow-build-env == 'manylinux'}}
        with:
          action: build-oneflow
          cmake-init-cache: cmake/caches/ci/cuda.cmake
          build-script: ci/manylinux/build.sh
          oneflow-src: .
          oneflow-build-env: manylinux
          wheelhouse-dir: manylinux-wheelhouse
          self-hosted: ${{ contains(matrix.os, 'self-hosted') }}
          cuda-version: 11.4
          manylinux-cache-dir: ~/manylinux-cache-dir/cuda-11.4
          docker-run-use-system-http-proxy: false
          docker-run-use-lld: true
          cache-key-prefixes: |
            ${{ github.repository }}/pr/${{ github.event.pull_request.number }}/${{ github.sha }}/${{ matrix.test_suite }}
            ${{ github.repository }}/digest/${{ hashFiles('**/*.cpp') }}
          python-versions: |
            3.6
            3.7

  test:
    name: Test suite
    needs: [set-initial-variables, build, wait_for_gpu_slot, changed_files]
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.allow_fail }}
    if: github.event.pull_request.draft == false && github.base_ref == 'master' && contains(github.event.pull_request.requested_reviewers.*.login, 'oneflow-ci-bot')
    strategy:
      matrix: ${{ fromJson(needs.set-initial-variables.outputs.test_matrix) }}
    steps:
      - name: Fix permissions
        run: |
          docker run --rm -v $PWD:/p -w /p busybox chmod -R o+w .
      - uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Download shared env
        uses: actions/download-artifact@v2
        with:
          name: ${{ matrix.build_env }}
      - name: Set environment variables
        env:
          test_suite: ${{matrix.test_suite }}
        run: |
          set -x
          extra_docker_args=""
          extra_docker_args+=" --cap-add=SYS_PTRACE --security-opt seccomp=unconfined"
          extra_docker_args+=" --env ONEFLOW_CI=1"

          # load shared environment variables
          cat ${{ matrix.build_env }} >> $GITHUB_ENV
          source ${{ matrix.build_env }}
          # check directory sha_dir exists
          ssh -o StrictHostKeyChecking=no ${builder_host} "[ -d ${sha_dir} ]"

          # dowload whl and bin
          scp -r $remote_whl_dir wheel_tmp
          if [ "$test_suite" == "cuda" ] || [  "$test_suite" == "cpu" ]; then
            scp -r $remote_bin_dir bin_tmp
          fi

          # set wheelpath
          wheelhouse_dir="${PWD}/wheel_tmp"
          extra_docker_args+=" --env ONEFLOW_WHEEL_PATH=${wheelhouse_dir}"
          echo "wheelhouse_dir=${wheelhouse_dir}" >> $GITHUB_ENV

          # set matrix environment variables
          echo "test_suite=${test_suite}" >> $GITHUB_ENV
          if [ "$test_suite" == "cuda" ] || [  "$test_suite" == "cpu" ]; then
            echo "bin_dir=${PWD}/bin_tmp" >> $GITHUB_ENV
          fi
          if [ "$test_suite" == "cpu" ] || [ "$test_suite" == "cpu_new_interface" ] || [ "$test_suite" == "xla_cpu" ]; then
            extra_docker_args+=" --env ONEFLOW_TEST_CPU_ONLY=1"
            extra_docker_args+=" --env CUDA_VISIBLE_DEVICES=-1"
          fi
          # set container_name
          container_name=pr-${{ github.event.pull_request.number }}-run-id-${{ github.run_id }}-${test_suite}-test
          extra_docker_args+=" --name ${container_name}"
          echo "container_name=${container_name}" >> $GITHUB_ENV

          extra_docker_args+=" --shm-size=8g --rm -w $PWD -v $PWD:$PWD"
          extra_docker_args+=" -v /dataset:/dataset:ro -v /model_zoo:/model_zoo:ro"


          oneflow_test_cache_dir="$HOME/ci-cache/${{ github.repository }}/test_cache"
          extra_docker_args+=" -v ${oneflow_test_cache_dir}:${oneflow_test_cache_dir}"
          extra_docker_args+=" -e ONEFLOW_TEST_CACHE_DIR=${oneflow_test_cache_dir}"

          echo "extra_docker_args=${extra_docker_args}" >> $GITHUB_ENV
          echo "image_name=oneflow-test:0.2" >> $GITHUB_ENV
          echo "pip_index_mirror=https://pypi.tuna.tsinghua.edu.cn/simple" >> $GITHUB_ENV

          img_cache_base_dir="$HOME/ci-cache/${{ github.repository }}/oneflow-test/0.1"
          pip_cache_docker_args="-v ${img_cache_base_dir}/dotcache/pip:/root/.cache/pip"
          echo "pip_cache_docker_args=${pip_cache_docker_args}" >> $GITHUB_ENV
      - name: Build docker image for testing
        run: |
          bash docker/ci/test/build.sh
      - name: Exe test
        timeout-minutes: 45
        if: contains(fromJson('["cuda", "cpu"]'), matrix.test_suite)
        run: |
          set -x
          docker run \
            ${{ env.extra_docker_args }} ${{ env.pip_cache_docker_args }} \
            ${image_name} \
            ${bin_dir}/oneflow_testexe
      - name: Build documentation
        timeout-minutes: 45
        if: matrix.test_suite == 'cpu'
        run: |
          set -x
          docker run ${{ env.extra_docker_args }} ${{ env.pip_cache_docker_args }} \
            ${image_name} \
            bash -c "python3 -m pip config set global.index-url ${{ env.pip_index_mirror }} && bash ci/test/try_install.sh && bash ci/test/build_docs.sh"
      - name: Single client op test (distributed, 1st try)
        timeout-minutes: 45
        if: matrix.test_suite == 'cuda' && needs.changed_files.outputs.should_run_single_client_tests == '1'
        continue-on-error: true
        id: distributed_try_1
        run: |
          python3 ci/test/distributed_run.py --mode=single_client --bash_script=ci/test/2node_op_test.sh --custom_img_tag=${{ env.image_name }} --oneflow_wheel_path=${{ env.wheelhouse_dir }} --oneflow_wheel_python_version=3.6
      - name: Single client op test (distributed, 2nd try)
        timeout-minutes: 45
        if: matrix.test_suite == 'cuda' && steps.distributed_try_1.outcome=='failure' && needs.changed_files.outputs.should_run_single_client_tests == '1'
        continue-on-error: true
        id: distributed_try_2
        run: |
          python3 ci/test/distributed_run.py --mode=single_client --bash_script=ci/test/2node_op_test.sh --custom_img_tag=${{ env.image_name }} --oneflow_wheel_path=${{ env.wheelhouse_dir }} --oneflow_wheel_python_version=3.6
      - name: Single client op test (distributed, 3rd try)
        timeout-minutes: 45
        if: matrix.test_suite == 'cuda' && steps.distributed_try_2.outcome=='failure' && needs.changed_files.outputs.should_run_single_client_tests == '1'
        continue-on-error: false
        id: distributed_try_3
        run: |
          python3 ci/test/distributed_run.py --mode=single_client --bash_script=ci/test/2node_op_test.sh --custom_img_tag=${{ env.image_name }} --oneflow_wheel_path=${{ env.wheelhouse_dir }} --oneflow_wheel_python_version=3.6
      - name: Doctest
        timeout-minutes: 45
        if: matrix.test_suite == 'cuda'
        run: |
          set -x
          docker run \
            ${{ env.extra_docker_args }} ${{ env.pip_cache_docker_args }} \
            ${image_name} \
            bash -c "python3 -m pip config set global.index-url ${{ env.pip_index_mirror }} && bash ci/test/try_install.sh && bash ci/test/doctest.sh"
      - name: Single client dry run test (run without runtime)
        timeout-minutes: 45
        if: matrix.test_suite == 'cuda' && needs.changed_files.outputs.should_run_single_client_tests == '1'
        run: |
          set -x
          docker run ${{ env.extra_docker_args }} ${{ env.pip_cache_docker_args }} \
            ${image_name} \
            bash -c "python3 -m pip config set global.index-url ${{ env.pip_index_mirror }} && bash ci/test/try_install.sh && bash ci/test/dry_run_test.sh"
      - name: Set environment variables (new_interface)
        if: contains(fromJson('["cuda_new_interface", "cpu_new_interface"]'), matrix.test_suite)
        run: |
          set -x
          echo "image_tag=oneflow-test-v2:0.1" >> $GITHUB_ENV
          echo "image_url=https://oneflow-static.oss-cn-beijing.aliyuncs.com/docker_images/oneflow-test-v2.0.1.tar.gz" >> $GITHUB_ENV

          img_cache_base_dir="$HOME/ci-cache/${{ github.repository }}/pytorch/pytorch/1.9.0-cuda10.2-cudnn7-runtime"
          pip_cache_docker_args="-v ${img_cache_base_dir}/dotcache/pip:/root/.cache/pip"
          echo "pip_cache_docker_args=${pip_cache_docker_args}" >> $GITHUB_ENV
      - name: Check image (new_interface)
        if: contains(fromJson('["cuda_new_interface", "cpu_new_interface"]'), matrix.test_suite)
        run: |
          if [[ "$(docker images -q ${{ env.image_tag }} 2> /dev/null)" == "" ]]; then
            echo "should_load_img=1" >> $GITHUB_ENV
          fi
      - name: Load image (new_interface)
        if: contains(fromJson('["cuda_new_interface", "cpu_new_interface"]'), matrix.test_suite) && env.should_load_img == '1'
        run: |
          wget ${{ env.image_url }}
          docker load -i $(basename "${{ env.image_url }}")
      - name: Module API test
        timeout-minutes: 45
        if: contains(fromJson('["cuda_new_interface", "cpu_new_interface"]'), matrix.test_suite)
        run: |
          docker run \
            ${{ env.extra_docker_args }} ${{ env.pip_cache_docker_args }} \
            -e ONEFLOW_TEST_DIR=$PWD/python/oneflow/test/modules \
            ${{ env.image_tag }} \
            bash -c "python3 -m pip config set global.index-url ${{ env.pip_index_mirror }} && bash ci/test/try_install.sh && bash ci/test/generic_test_multi_client.sh"
      - name: Module API test (distributed, 1st try)
        if: matrix.test_suite == 'cuda_new_interface'
        continue-on-error: true
        id: new_interface_distributed_try_1
        run: |
          python3 ci/test/distributed_run.py --bash_script ci/test/2node_op_test_multi_client.sh --copy_files python/oneflow/test/ --copy_files python/oneflow/test_utils/ --copy_files ci/test/ --custom_img_tag=${{ env.image_tag }} --oneflow_wheel_path=${{ env.wheelhouse_dir }} --oneflow_wheel_python_version=3.7
      - name: Module API test (distributed, 2nd try)
        if: matrix.test_suite == 'cuda_new_interface' && steps.new_interface_distributed_try_1.outcome=='failure'
        continue-on-error: true
        id: new_interface_distributed_try_2
        run: |
          python3 ci/test/distributed_run.py --bash_script ci/test/2node_op_test_multi_client.sh --copy_files python/oneflow/test/ --copy_files python/oneflow/test_utils/ --copy_files ci/test/ --custom_img_tag=${{ env.image_tag }} --oneflow_wheel_path=${{ env.wheelhouse_dir }} --oneflow_wheel_python_version=3.7
      - name: Module API test (distributed, 3rd try)
        if: matrix.test_suite == 'cuda_new_interface' && steps.new_interface_distributed_try_2.outcome=='failure'
        continue-on-error: false
        id: new_interface_distributed_try_3
        run: |
          python3 ci/test/distributed_run.py --bash_script ci/test/2node_op_test_multi_client.sh --copy_files python/oneflow/test/ --copy_files python/oneflow/test_utils/ --copy_files ci/test/ --custom_img_tag=${{ env.image_tag }} --oneflow_wheel_path=${{ env.wheelhouse_dir }} --oneflow_wheel_python_version=3.7
      - name: Upload log (distributed test)
        if: always() && (steps.distributed_try_3.outcome=='failure' && matrix.test_suite == 'cuda') || (steps.new_interface_distributed_try_3.outcome=='failure' && matrix.test_suite == 'cuda_new_interface')
        uses: ./.github/actions/upload_oss
        with:
          src_path: distributed-tmp
          oss_dst_path: oss://oneflow-log/${{ github.repository }}/pr/${{ github.event.pull_request.number }}/${{github.run_id}}/distributed-tmp
          oss_access_key_id: ${{ secrets.OSS_ACCESS_KEY_ID }}
          oss_access_key_secret: ${{ secrets.OSS_ACCESS_KEY_SECRET }}
          upload_core: ${{ contains(github.event.pull_request.labels.*.name, 'upload-core') }}
      - name: Print backtrace (distributed test)
        if: always() && (steps.distributed_try_3.outcome=='failure' && matrix.test_suite == 'cuda') || (steps.new_interface_distributed_try_3.outcome=='failure' && matrix.test_suite == 'cuda_new_interface')
        run: |
          set -x
          docker run \
            ${{ env.extra_docker_args }} ${{ env.pip_cache_docker_args }} \
            ${image_name} bash ci/test/print_stack_from_core.sh python3 distributed-tmp
      - name: Dataloader API test
        timeout-minutes: 45
        if: contains(fromJson('["cuda_new_interface", "cpu_new_interface"]'), matrix.test_suite)
        run: |
          docker run \
            ${{ env.extra_docker_args }} ${{ env.pip_cache_docker_args }} \
            -e ONEFLOW_TEST_DIR=$PWD/python/oneflow/test/dataloader \
            ${{ env.image_tag }} \
            bash -c "python3 -m pip config set global.index-url ${{ env.pip_index_mirror }} && python3 -m pip install -r docker/ci/test-v2/requirements.txt --user && bash ci/test/try_install.sh && bash ci/test/generic_test_multi_client.sh"
      - name: Tensor API test
        timeout-minutes: 45
        if: contains(fromJson('["cuda_new_interface", "cpu_new_interface"]'), matrix.test_suite)
        run: |
          docker run \
            ${{ env.extra_docker_args }} ${{ env.pip_cache_docker_args }} \
            -e ONEFLOW_TEST_DIR=$PWD/python/oneflow/test/tensor \
            ${{ env.image_tag }} \
            bash -c "python3 -m pip config set global.index-url ${{ env.pip_index_mirror }} && bash ci/test/try_install.sh && bash ci/test/generic_test_multi_client.sh"
      - name: Graph API test
        if: contains(fromJson('["cuda_new_interface", "cpu_new_interface"]'), matrix.test_suite)
        run: |
          docker run \
            ${{ env.extra_docker_args }} ${{ env.pip_cache_docker_args }} \
            -e ONEFLOW_TEST_DIR=$PWD/python/oneflow/test/graph \
            ${{ env.image_tag }} \
            bash -c "python3 -m pip config set global.index-url ${{ env.pip_index_mirror }} && bash ci/test/try_install.sh && bash ci/test/generic_test_multi_client.sh"
      - name: Checkout Oneflow-Inc/models
        if: matrix.test_suite == 'cuda_new_interface'
        uses: actions/checkout@v2
        with:
          repository: Oneflow-Inc/models
          ref: 7a6845f7d7133c02a01a75b9ca525e6c40e99639
          path: oneflow-models
      - name: Speed test
        id: speed
        if: matrix.test_suite == 'cuda_new_interface'
        run: |
          docker run \
            ${{ env.extra_docker_args }} ${{ env.pip_cache_docker_args }} \
            -e ONEFLOW_MODELS_DIR=$PWD/oneflow-models \
            ${{ env.image_tag }} \
            bash -c "python3 -m pip config set global.index-url ${{ env.pip_index_mirror }} && bash ci/test/try_install.sh && bash ci/test/test_speed_multi_client.sh"
      - name: Post speed stats
        if: matrix.test_suite == 'cuda_new_interface'
        continue-on-error: true
        uses: actions/github-script@v4
        with:
          script: |
            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "<details>\n <summary>Speed stats:</summary>\n\n ``` \n${{ steps.speed.outputs.stats }}\n ``` \n\n</details>".replace(/\\n/g, '\n')
            })
      - name: Single client op test
        timeout-minutes: 45
        if: contains(fromJson('["cuda_op", "cpu"]'), matrix.test_suite) && needs.changed_files.outputs.should_run_single_client_tests == '1'
        run: |
          set -x
          docker run \
            ${{ env.extra_docker_args }} ${{ env.pip_cache_docker_args }} \
            ${image_name} \
            bash -c "python3 -m pip config set global.index-url ${{ env.pip_index_mirror }} && bash ci/test/try_install.sh && bash ci/test/1node_op_test.sh"
      - name: Single client model test
        timeout-minutes: 45
        if: contains(fromJson('["cuda", "cpu"]'), matrix.test_suite)  && needs.changed_files.outputs.should_run_single_client_tests == '1'
        run: |
          set -x
          docker run \
            ${{ env.extra_docker_args }} ${{ env.pip_cache_docker_args }} \
            ${image_name} \
            bash -c "python3 -m pip config set global.index-url ${{ env.pip_index_mirror }} && bash ci/test/try_install.sh && bash ci/test/1node_model_test.sh"
      - name: Single client model serve test
        timeout-minutes: 45
        id: model_serve_test
        if: matrix.test_suite == 'cuda' && needs.changed_files.outputs.should_run_single_client_tests == '1'
        run: |
          set -x
          docker run ${{ env.extra_docker_args }} ${{ env.pip_cache_docker_args }} \
            --env ONEFLOW_TEST_TMP_DIR=$PWD/serving-tmp \
            ${image_name} \
            bash -c "python3 -m pip config set global.index-url ${{ env.pip_index_mirror }} && bash ci/test/try_install.sh && bash ci/test/1node_model_serve_test.sh"
      - name: Print backtrace (serving test)
        if: always() && steps.model_serve_test.outcome=='failure'  && matrix.test_suite == 'cuda'
        run: |
          set -x
          docker run ${{ env.extra_docker_args }} ${{ env.pip_cache_docker_args }} \
            ${image_name} bash ci/test/print_stack_from_core.sh python3 serving-tmp
      - name: Single client benchmark (mainly for backward compatibility)
        timeout-minutes: 45
        if: matrix.test_suite == 'cuda' && needs.changed_files.outputs.should_run_single_client_tests == '1'
        run: |
          set -x
          docker run ${{ env.extra_docker_args }} ${{ env.pip_cache_docker_args }} \
            ${image_name} \
            bash -c "python3 -m pip config set global.index-url ${{ env.pip_index_mirror }} && bash ci/test/try_install.sh && bash ci/test/1node_benchmark_test.sh"
      - name: Single client benchmark FP16 (mainly for backward compatibility)
        timeout-minutes: 45
        if: matrix.test_suite == 'cuda' && needs.changed_files.outputs.should_run_single_client_tests == '1'
        run: |
          set -x
          docker run ${{ env.extra_docker_args }} ${{ env.pip_cache_docker_args }} \
            ${image_name} \
            bash -c "python3 -m pip config set global.index-url ${{ env.pip_index_mirror }} && bash ci/test/try_install.sh && bash ci/test/1node_benchmark_test_fp16.sh"
      - name: Single client XLA Test
        timeout-minutes: 45
        if: contains(fromJson('["xla", "xla_cpu"]'), matrix.test_suite) && needs.changed_files.outputs.should_run_single_client_tests == '1'
        run: |
          set -x
          docker run ${{ env.extra_docker_args }} ${{ env.pip_cache_docker_args }} \
            ${image_name} \
            bash -c "python3 -m pip config set global.index-url ${{ env.pip_index_mirror }} && bash ci/test/try_install.sh && bash ci/test/test_xla.sh"
      - name: Remove automerge
        if: contains(fromJson('["cuda_new_interface", "cpu_new_interface", "cpu", "cuda", "cuda_op"]'), matrix.test_suite) && failure() && cancelled() == false && contains(github.event.pull_request.labels.*.name, 'automerge')
        uses: actions/github-script@v4
        with:
          script: |
            github.issues.removeLabel({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'automerge'
            })
            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'CI failed, removing label automerge'
            })
      - name: Print stacks in all core files
        timeout-minutes: 45
        if: contains(fromJson('["cuda_new_interface", "cpu_new_interface"]'), matrix.test_suite) == false && failure()
        run: |
          set -x
          docker run ${{ env.extra_docker_args }} ${{ env.pip_cache_docker_args }} \
            ${image_name} \
            bash -c "python3 -m pip config set global.index-url ${{ env.pip_index_mirror }} && bash ci/test/try_install.sh && bash ci/test/print_stack_in_all_dirs.sh"
      - name: Print stacks in all core files (new interface)
        timeout-minutes: 45
        if: contains(fromJson('["cuda_new_interface", "cpu_new_interface"]'), matrix.test_suite) && failure()
        run: |
          set -x
          docker run \
            ${{ env.extra_docker_args }} ${{ env.pip_cache_docker_args }} \
            ${{ env.image_tag }} \
            bash -c "python3 -m pip config set global.index-url ${{ env.pip_index_mirror }} && bash ci/test/try_install.sh && bash ci/test/print_stack_in_all_dirs.sh"
      - name: Query system status
        timeout-minutes: 45
        if: failure()
        run: |
          nvidia-smi
          docker ps
      - name: Remove container
        timeout-minutes: 45
        if: always()
        run: |
          docker rm -f ${container_name} || true

  static_analysis_with_clang_on_diff:
    name: Static analysis with clang on diff
    runs-on: ubuntu-20.04
    if: github.event.pull_request.draft == false && github.base_ref == 'master' && contains(github.event.pull_request.requested_reviewers.*.login, 'oneflow-ci-bot')
    steps:
      - name: Check out OneFlow
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{github.event.pull_request.head.repo.full_name}}
          fetch-depth: 0
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libopenblas-dev nasm python3-pip ninja-build ccache
      - name: Download OneFlow custom clang-tidy
        run: |
          wget https://github.com/Oneflow-Inc/llvm-project/releases/download/latest/clang-tidy-489012f-x86_64.AppImage
          wget https://raw.githubusercontent.com/oneflow-inc/llvm-project/maybe/clang-tools-extra/clang-tidy/tool/clang-tidy-diff.py
          chmod +x clang-tidy-489012f-x86_64.AppImage clang-tidy-diff.py
      - name: Cache third party dir
        uses: actions/cache@v2
        with:
          path: ~/.ccache
          key: clang-tidy-diff-third-party-ccache-${{ hashFiles('**/CMakeLists.txt') }}-${{ hashFiles('**/*.cmake') }}
          restore-keys: |
            clang-tidy-diff-third-party-ccache-${{ hashFiles('**/CMakeLists.txt') }}-
            clang-tidy-diff-third-party-ccache-
      - name: Build third party libs and generate files
        run: |
          export CCACHE_COMPRESS=true
          export CCACHE_MAXSIZE=500M
          mkdir build
          cd build
          cmake .. -C ../cmake/caches/international/cpu.cmake \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTING=ON \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
          cmake --build . -j$(nproc) --target oneflow_deps of_cfgobj of_protoobj of_functional_obj of_functional_tensor_obj
      - name: Fetch upstream
        if: github.event.pull_request.head.repo.full_name != github.event.pull_request.base.repo.full_name
        run: |
          git remote add upstream https://github.com/Oneflow-Inc/oneflow
          git fetch upstream
      - name: Run clang-tidy for modified files
        # use clang as compiler for correct compiler flags
        run: |
          cd build
          rm CMakeCache.txt
          cmake .. -C ../cmake/caches/international/cpu.cmake \
            -DCMAKE_C_COMPILER=clang-12 \
            -DCMAKE_CXX_COMPILER=clang++-12 \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTING=ON \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          cd ..
          git diff -U0 ${{ github.event.pull_request.base.sha }} | ./clang-tidy-diff.py -clang-tidy-binary ./clang-tidy-489012f-x86_64.AppImage -path build -allow-enabling-alpha-checkers -j $(nproc) -p1 -extra-arg="-Xclang" -extra-arg="-analyzer-config" -extra-arg="-Xclang" -extra-arg="aggressive-binary-operation-simplification=true" -warnings-as-errors="*,-maybe-glog-fatal,-clang-analyzer-alpha.*"
      - name: Remove automerge
        if: failure() && cancelled() == false && contains(github.event.pull_request.labels.*.name, 'automerge')
        uses: actions/github-script@v4
        with:
          script: |
            github.issues.removeLabel({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'automerge'
            })
            github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'CI failed, removing label automerge'
            })
