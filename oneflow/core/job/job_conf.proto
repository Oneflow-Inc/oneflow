syntax = "proto2";
package oneflow;

import "oneflow/core/common/data_type.proto";
import "oneflow/core/operator/op_conf.proto";
import "oneflow/core/job/dlnet_conf.proto";
import "oneflow/core/job/resource.proto";
import "oneflow/core/job/placement.proto";

message TrainConf {
  required int64 batch_size = 1; // batch_size % piece_size = 0
  required NormalModelUpdateOpUserConf model_update_conf = 3;
  required string model_save_snapshots_path = 4;
  required int32 num_of_batches_in_snapshot = 5;

  optional InitializerConf default_initializer_conf = 100;
  required float primary_lr = 101;
  optional float secondary_lr = 102 [default = -1];
  optional float weight_l1 = 103 [default = 0];
  optional float bias_l1 = 104 [default = 0];
  optional float weight_l2 = 105 [default = 0];
  optional float bias_l2 = 106 [default = 0];
  optional int64 piece_num_of_print_loss = 107 [default = -1];
  optional int64 piece_num_of_print_accuracy = 108 [default = -1];
}

message PredictConf {
}

message LocalFsConf {
}

message NetworkFsConf {
}

message HdfsConf {
  required string namenode = 1;
}

message FileSystemConf {
  oneof fs_type {
    LocalFsConf localfs_conf = 1;
    NetworkFsConf networkfs_conf = 2;
    HdfsConf hdfs_conf = 3;
  }
}

message ExperimentalRunConf {
  optional int64 piece_num_of_experiment_phase = 1 [default = -1];
  optional bool enable_experiment_run = 2 [default = false];
}

message OtherConf {
  required int64 piece_size = 2;
  required int32 data_part_num = 3; // piece_size % data_part_num = 0
  required int64 total_batch_num = 4;

  optional bool use_rdma = 100 [default = false];
  optional string model_load_snapshot_path = 101 [default = ""];
  optional int32 max_data_id_length = 102 [default = 0];
  optional bool enable_cudnn = 103 [default = true];
  optional DataType default_data_type = 104 [default = kFloat]; // kFloat or kDouble
  optional ExperimentalRunConf exp_run_conf = 105;
  optional uint64 persistence_buf_mbyte = 106 [default = 64];
  optional uint64 reserved_host_mem_mbyte = 107 [default = 500];
  optional uint64 reserved_device_mem_mbyte = 108 [default = 500];
  optional bool save_downloaded_file_to_local_fs = 109 [default = false];
  optional uint64 rdma_mem_block_mbyte = 110 [default = 8];
  optional uint64 rdma_recv_msg_buf_mbyte = 111 [default = 6];
  required FileSystemConf data_fs_conf = 112;
  required FileSystemConf snapshot_fs_conf = 113;

  optional bool collect_act_event = 125 [default = false];
  optional bool enable_mem_sharing = 126 [default = true];
  optional bool enable_write_snapshot = 130 [default = true];
  optional bool enable_blob_mem_sharing = 140 [default = true];
  optional bool enable_nccl = 142 [default = true];
  optional bool use_nccl_inter_node_communication = 143 [default = false];
  optional int64 cudnn_buf_limit_mbyte = 144 [default = 1024];  // 1GByte
  optional int64 reduce_group_num = 145 [default = 5];
  optional float lazy_reduce_ratio = 146 [default = 0.0];
  optional float reduce_model_update_overlapping_ratio = 147 [default = 0.1];

  oneof JobType {
    TrainConf train_conf = 200;
    PredictConf predict_conf = 201;
  }
}

message JobConf1 {
  required DLNetConf net = 1;
  required Resource resource = 2;
  required Placement placement = 3;
  required OtherConf other = 4;
}

message JobConf2 {
  required string net = 1;
  required string resource = 2;
  required string placement = 3;
  required string other = 4;
}
