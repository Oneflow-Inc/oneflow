syntax = "proto2";
package oneflow;

import "oneflow/core/operator/op_conf.proto";
import "oneflow/core/common/data_type.proto";
import "oneflow/core/job/resource.proto";

message Pad {
  required int32 small_side = 1;
  required int32 large_side = 2;
}

message Conv1DKernelConf {
  repeated Pad pad = 1;
  optional int32 cudnn_fwd_algo = 2 [default = 0];
  optional int32 cudnn_bwd_filter_algo = 3 [default = 0];
  optional int32 cudnn_bwd_data_algo = 4 [default = 0];
}

message Conv2DKernelConf {
  repeated Pad pad = 1;
  optional int32 cudnn_fwd_algo = 2 [default = 0];
  optional int32 cudnn_bwd_filter_algo = 3 [default = 0];
  optional int32 cudnn_bwd_data_algo = 4 [default = 0];
}

message Conv3DKernelConf {
  repeated Pad pad = 1;
  optional int32 cudnn_fwd_algo = 2 [default = 0];
  optional int32 cudnn_bwd_filter_algo = 3 [default = 0];
  optional int32 cudnn_bwd_data_algo = 4 [default = 0];
}

message ConcatKernelConf {
  required int64 total_cp_num = 1;
  repeated int64 per_cp_bytesize = 2;
}

message MultinomialLogisticLossKernelConf { 
  required DataType prediction_type = 1;
  required DataType label_type = 2;
}

message SoftmaxLossKernelConf { 
  required DataType prediction_type = 1;
  required DataType label_type = 2;
}

message Pooling2DKernelConf {
  optional int32 padding_top = 1 [default = 0];
  optional int32 padding_bottom = 2 [default = 0];
  optional int32 padding_left = 3 [default = 0];
  optional int32 padding_right = 4 [default = 0];
}

message AveragePooling2DKernelConf {
  required Pooling2DKernelConf pooling_2d_conf = 1;
}

message MaxPooling2DKernelConf {
  required Pooling2DKernelConf pooling_2d_conf = 1;
}

message ReduceSumKernelConf {
  optional int32 axis = 1;
}

message KernelConf {
  required OperatorConf op_conf = 1;
  map<string, string> bn_in_op2lbn = 2;
  
  repeated string data_tmp_bns = 3;
  repeated string input_bns = 4;
  repeated string input_diff_bns = 5;
  repeated string output_bns = 6;
  repeated string output_diff_bns = 7;

  repeated string model_bns = 8;
  repeated string model_diff_bns = 9;
  repeated string model_tmp_bns = 10;

  required bool need_do_data_id = 12;
  required bool need_do_col_num = 13;
  required bool is_forward = 14;
  required DataType data_type = 15;
  required DeviceType device_type = 16;

  oneof kernel_type {
    MultinomialLogisticLossKernelConf multinomial_logistic_loss_conf = 106;
    ConcatKernelConf concat_conf = 113;
    SoftmaxLossKernelConf softmax_loss_conf = 117;
    ReduceSumKernelConf reduce_sum_conf = 120;
    Conv1DKernelConf conv_1d_conf = 125;
    Conv2DKernelConf conv_2d_conf = 126;
    Conv3DKernelConf conv_3d_conf = 127;
    AveragePooling2DKernelConf average_pooling_2d_conf = 200;
    MaxPooling2DKernelConf max_pooling_2d_conf = 201;
  }
}
