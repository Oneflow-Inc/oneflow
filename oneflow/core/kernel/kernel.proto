syntax = "proto2";
package oneflow;

import "oneflow/core/operator/op_conf.proto";
import "oneflow/core/common/data_type.proto";

message ConvolutionKernelConf {
  enum cudnnConvolutionFwdAlgo_t {
    CUDNN_CONVOLUTION_FWD_ALGO_IMPLICIT_GEMM = 0;
    CUDNN_CONVOLUTION_FWD_ALGO_IMPLICIT_PRECOMP_GEMM = 1;
    CUDNN_CONVOLUTION_FWD_ALGO_GEMM = 2;
    CUDNN_CONVOLUTION_FWD_ALGO_DIRECT = 3;
    CUDNN_CONVOLUTION_FWD_ALGO_FFT = 4;
    CUDNN_CONVOLUTION_FWD_ALGO_FFT_TILING = 5;
    CUDNN_CONVOLUTION_FWD_ALGO_WINOGRAD = 6;
    CUDNN_CONVOLUTION_FWD_ALGO_WINOGRAD_NONFUSED = 7;
    CUDNN_CONVOLUTION_FWD_ALGO_COUNT = 8;
  }
  enum cudnnConvolutionBwdFilterAlgo_t {
    CUDNN_CONVOLUTION_BWD_FILTER_ALGO_0 = 0;
    CUDNN_CONVOLUTION_BWD_FILTER_ALGO_1 = 1;
    CUDNN_CONVOLUTION_BWD_FILTER_ALGO_FFT = 2;
    CUDNN_CONVOLUTION_BWD_FILTER_ALGO_3 = 3;
    CUDNN_CONVOLUTION_BWD_FILTER_ALGO_WINOGRAD = 4;
    CUDNN_CONVOLUTION_BWD_FILTER_ALGO_WINOGRAD_NONFUSED = 5;
    CUDNN_CONVOLUTION_BWD_FILTER_ALGO_FFT_TILING = 6;
    CUDNN_CONVOLUTION_BWD_FILTER_ALGO_COUNT = 7;
  }
  enum cudnnConvolutionBwdDataAlgo_t {
    CUDNN_CONVOLUTION_BWD_DATA_ALGO_0 = 0;
    CUDNN_CONVOLUTION_BWD_DATA_ALGO_1 = 1;
    CUDNN_CONVOLUTION_BWD_DATA_ALGO_FFT = 2;
    CUDNN_CONVOLUTION_BWD_DATA_ALGO_FFT_TILING = 3;
    CUDNN_CONVOLUTION_BWD_DATA_ALGO_WINOGRAD = 4;
    CUDNN_CONVOLUTION_BWD_DATA_ALGO_WINOGRAD_NONFUSED = 5;
    CUDNN_CONVOLUTION_BWD_DATA_ALGO_COUNT = 6;
  }
  optional cudnnConvolutionFwdAlgo_t cudnn_fwd_algo = 14 [default = CUDNN_CONVOLUTION_FWD_ALGO_IMPLICIT_GEMM];
  optional cudnnConvolutionBwdFilterAlgo_t cudnn_bwd_filter_algo = 15 [default = CUDNN_CONVOLUTION_BWD_FILTER_ALGO_0];
  optional cudnnConvolutionBwdDataAlgo_t cudnn_bwd_data_algo = 16 [default = CUDNN_CONVOLUTION_BWD_DATA_ALGO_0];
}

message ConcatKernelConf {
  required int64 total_cp_num = 1;
  repeated int64 per_cp_bytesize = 2;
}

message MultinomialLogisticLossKernelConf { 
  required DataType prediction_type = 1;
  required DataType label_type = 2;
}

message SoftmaxLossKernelConf { 
  required DataType prediction_type = 1;
  required DataType label_type = 2;
}

message SumKernelConf {
  required int32 axis = 1;
}

message KernelConf {
  required OperatorConf op_conf = 1;
  map<string, string> bn_in_op2lbn = 2;
  
  repeated string data_tmp_bns = 3;
  repeated string input_bns = 4;
  repeated string input_diff_bns = 5;
  repeated string output_bns = 6;
  repeated string output_diff_bns = 7;

  repeated string model_bns = 8;
  repeated string model_diff_bns = 9;
  repeated string model_tmp_bns = 10;

  required bool need_do_data_id = 12;
  required bool is_forward = 13;
  required DataType data_type = 14;

  oneof kernel_type {
    ConvolutionKernelConf convolution_conf = 100;
    MultinomialLogisticLossKernelConf multinomial_logistic_loss_conf = 106;
    ConcatKernelConf concat_conf = 113; 
    SoftmaxLossKernelConf softmax_loss_conf = 117;
    SumKernelConf sum_conf = 120;
  }
}
