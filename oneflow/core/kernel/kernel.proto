syntax = "proto2";
package oneflow;

import "oneflow/core/common/shape.proto";
import "oneflow/core/common/data_type.proto";
import "oneflow/core/register/logical_blob_id.proto";
import "oneflow/core/operator/op_conf.proto";

message ConvKernelConf {
  required ShapeProto in = 1;
  required ShapeProto out = 2;
  required ShapeProto weight = 3;
  required int32 dim = 4;
  repeated int32 pad_small_side = 5;
  repeated int32 pad_large_side = 6;
  repeated int32 dilation_rate = 7;
  repeated int32 strides = 8;
  optional int32 cudnn_fwd_algo = 9 [default = -1];
  optional int32 cudnn_bwd_filter_algo = 10 [default = -1];
  optional int32 cudnn_bwd_data_algo = 11 [default = -1];
}

message DropoutKernelConf {
  required ShapeProto in = 1;
  required ShapeProto random_mask = 2;
  required ShapeProto out = 3;
};

message LossKernelConf { 
  required DataType prediction_type = 1;
  required DataType label_type = 2;
  required float weight_scalar = 3;
  required LossReductionType reduction = 4;
}

message SparseSoftmaxCrossEntropyLossKernelConf {
  required LossKernelConf loss_conf = 1;
}

message SparseCrossEntropyLossKernelConf {
  required LossKernelConf loss_conf = 1;
}

message PoolingKernelConf {
  required ShapeProto in = 1;
  required ShapeProto out = 2;
  required int32 dim = 3;
  repeated int32 padding_before = 4;
  repeated int32 padding_after = 5;
  repeated int32 pool_size = 6;
  repeated int32 strides = 7;
  required string data_format = 8;
}

message AveragePoolingKernelConf {
  required PoolingKernelConf pooling_conf = 1;
}

message MaxPoolingKernelConf {
  required PoolingKernelConf pooling_conf = 1;
}

message ReduceSumKernelConf {
  optional int32 axis = 1;
}

message SoftmaxKernelConf {
  required int32 axis = 1;
  required int64 transpose_rows = 2;
  required int64 transpose_cols = 3;
  required bool need_transpose = 4;
  repeated int32 perm = 5;
}

message TransposeKernelConf {
  repeated int32 perm = 1;
  repeated int32 invert_perm = 2; 
}

message LocalResponseNormalizationKernelConf {
  required ShapeProto batch = 1;
}

message NormalizationKernelConf {
  optional int32 axis = 1;
  optional int64 transpose_rows = 2;
  optional int64 transpose_cols = 3;
  optional bool need_transpose = 4;
  repeated int32 perm = 5;

  required bool use_cudnn = 6;
  optional ShapeProto in = 7;
  optional int32 cudnn_bn_mode = 8;
}

message DecodeRandomKernelConf {
  required uint32 random_seed = 1;
}

message DecodeOFRecordKernelConf {
  required uint32 random_seed = 1;
}

message ReduceGatherKernelConf {
  repeated int64 data_offset = 1;
}

message ReduceConcatKernelConf {
  repeated int64 data_offset = 1;
}

message ReduceSplitKernelConf {
  repeated int64 data_offset = 1;
}

message AccuracyKernelConf { 
  required DataType prediction_type = 1;
  required DataType label_type = 2;
}

message OpAttribute {
  required OperatorConf op_conf = 1;
  map<string, LogicalBlobId> bn_in_op2lbi = 2;
  
  repeated string input_bns = 3;
  repeated string input_diff_bns = 4;
  repeated string output_bns = 5;
  repeated string output_diff_bns = 6;
  repeated string data_tmp_bns = 7;
  repeated string fw_buf_bns = 8;
  repeated string bw_buf_bns = 9;

  repeated string model_bns = 10;
  repeated string model_diff_bns = 11;
  repeated string const_model_bns = 12;
  repeated string instance_num_bns = 13;
  
  repeated string forward_model_bns = 14;
  repeated string const_buf_bns = 15;
}

message HingeLossKernelConf {
  required LossKernelConf loss_conf = 1;
}

message KernelConf {
  required OpAttribute op_attribute = 1; 
  optional bool need_do_data_id = 2 [default = false];
  optional bool need_do_col_num = 3 [default = false];
  optional bool need_do_opaque_header = 4 [default = false];
  required bool is_forward = 5;
  required DataType data_type = 6;
  optional ActivationType forward_activation = 7 [default = kNone];
  optional ActivationType backward_activation = 8 [default = kNone];

  oneof kernel_type {
    SparseSoftmaxCrossEntropyLossKernelConf sparse_softmax_cross_entropy_loss_conf = 101;
    SparseCrossEntropyLossKernelConf sparse_cross_entropy_loss_conf = 102;
    DecodeRandomKernelConf decode_random_conf = 103;
    DecodeOFRecordKernelConf decode_ofrecord_conf = 104;
    HingeLossKernelConf hinge_loss_conf = 105;
    SoftmaxKernelConf softmax_conf = 116;
    TransposeKernelConf transpose_conf = 117;
    ReduceSumKernelConf reduce_sum_conf = 120;
    ConvKernelConf conv_conf = 127;
    DropoutKernelConf dropout_conf = 140;
    AveragePoolingKernelConf average_pooling_conf = 204;
    MaxPoolingKernelConf max_pooling_conf = 205;
    NormalizationKernelConf normalization_conf = 250;
    LocalResponseNormalizationKernelConf local_response_normalization_conf = 300;
    ReduceGatherKernelConf reduce_gather_conf = 350;
    ReduceConcatKernelConf reduce_concat_conf = 351;
    ReduceSplitKernelConf reduce_split_conf = 352;
    AccuracyKernelConf accuracy_conf = 401;
  }
}
