syntax = "proto2";
package oneflow;

import "oneflow/core/common/shape.proto";
import "oneflow/core/operator/op_conf.proto";
import "oneflow/core/common/data_type.proto";
import "oneflow/core/job/resource.proto";

message LossKernelConf { 
  required DataType prediction_type = 1;
  required DataType label_type = 2;
}

message SparseSoftmaxCrossEntropyLossKernelConf {
  required LossKernelConf loss_conf = 1;
}

message SparseCrossEntropyLossKernelConf {
  required LossKernelConf loss_conf = 1;
}

message PoolingKernelConf {
  required ShapeProto in= 1;
  required ShapeProto out= 2;
  repeated int32 padding_before = 3;
  repeated int32 padding_after = 4;
  repeated int32 pool_size = 5;
  repeated int32 strides = 6;
  required string data_format = 7;
}

message AveragePoolingKernelConf {
  required PoolingKernelConf pooling_conf = 1;
}

message MaxPoolingKernelConf {
  required PoolingKernelConf pooling_conf = 1;
}

message ReduceSumKernelConf {
  optional int32 axis = 1;
}

message SoftmaxKernelConf {
  required int32 axis = 1;
  required int64 transpose_rows = 2;
  required int64 transpose_cols = 3;
  required bool need_transpose = 4;
  repeated int32 perm = 5;
}

message KernelConf {
  required OperatorConf op_conf = 1;
  map<string, string> bn_in_op2lbn = 2;
  
  repeated string data_tmp_bns = 3;
  repeated string input_bns = 4;
  repeated string input_diff_bns = 5;
  repeated string output_bns = 6;
  repeated string output_diff_bns = 7;

  repeated string model_bns = 8;
  repeated string model_diff_bns = 9;
  repeated string model_tmp_bns = 10;

  required bool need_do_data_id = 12;
  required bool need_do_col_num = 13;
  required bool is_forward = 14;
  required DataType data_type = 15;
  required DeviceType device_type = 16;

  oneof kernel_type {
    SparseSoftmaxCrossEntropyLossKernelConf sparse_softmax_cross_entropy_loss_conf = 101;
    SparseCrossEntropyLossKernelConf sparse_cross_entropy_loss_conf = 102;
    SoftmaxKernelConf softmax_conf = 116;
    ReduceSumKernelConf reduce_sum_conf = 120;
    AveragePoolingKernelConf average_pooling_conf = 204;
    MaxPoolingKernelConf max_pooling_conf = 205;
  }
}
