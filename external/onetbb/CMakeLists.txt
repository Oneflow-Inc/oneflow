find_package(Threads REQUIRED)
set(ONETBB_INSTALL_DIR ${THIRD_PARTY_DIR}/tbb CACHE PATH " ")

include(FetchContent)
FetchContent_Declare(
  tbb
  URL ${ONETBB_URL}
  URL_HASH MD5=${ONETBB_MD5}
)
FetchContent_GetProperties(tbb)


set(CMAKE_CXX_FLAGS "" CACHE STRING "" FORCE)
set(CMAKE_CXX_FLAGS_DEBUG "" CACHE STRING "" FORCE)
set(CMAKE_CXX_FLAGS_RELEASE "" CACHE STRING "" FORCE)
set(CMAKE_CXX_FLAGS_RELWITHDEBINFO "" CACHE STRING "" FORCE)
set(CMAKE_C_FLAGS "" CACHE STRING "" FORCE)
set(CMAKE_C_FLAGS_DEBUG "" CACHE STRING "" FORCE)
set(CMAKE_C_FLAGS_RELEASE "" CACHE STRING "" FORCE)
set(CMAKE_C_FLAGS_RELWITHDEBINFO "" CACHE STRING "" FORCE)
set(CMAKE_BUILD_TYPE "Release" CACHE STRING "" FORCE)
set(TBB_EXAMPLES OFF CACHE BOOL "")
set(TBB_TEST OFF CACHE BOOL "")
set(BUILD_SHARED_LIBS ON BOOL "")
set(CMAKE_POLICY_DEFAULT_CMP0079 NEW)
FetchContent_MakeAvailable(tbb)
set_property(GLOBAL PROPERTY TBB_INCLUDE_DIRS "${tbb_SOURCE_DIR}/cpp/src;${tbb_BINARY_DIR}/src")

install(TARGETS tbb tbbmalloc tbbmalloc_proxy COMPONENT OneFlowTBB)
install(DIRECTORY ${tbb_SOURCE_DIR}/include DESTINATION ${ONETBB_INSTALL_DIR} COMPONENT OneFlowTBB)

add_custom_target(install-tbb
  DEPENDS tbb tbbmalloc tbbmalloc_proxy
  COMMAND
      "${CMAKE_COMMAND}" -DCMAKE_INSTALL_PREFIX=${ONETBB_INSTALL_DIR}
      -DCMAKE_INSTALL_COMPONENT=OneFlowTBB
      -P "${CMAKE_BINARY_DIR}/cmake_install.cmake"
)