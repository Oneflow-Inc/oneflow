include (ExternalProject)

set(OPENCV_INCLUDE_DIR ${THIRD_PARTY_DIR}/opencv/include)
set(OPENCV_LIBRARY_DIR ${THIRD_PARTY_DIR}/opencv/lib)
set(OPENCV_INSTALL_DIR ${CMAKE_CURRENT_BINARY_DIR}/opencv/src/opencv/build/install)

set(OPENCV_SRC_DIR ${CMAKE_CURRENT_BINARY_DIR}/opencv/src/opencv/src)
set(OPENCV_URL https://github.com/Oneflow-Inc/opencv.git)
set(OPENCV_TAG 51cef2651e91003e6a6760f496719dbb325cfc61)

if(WIN32)
elseif(APPLE AND ("${CMAKE_GENERATOR}" STREQUAL "Xcode"))
else()
    set(OPENCV_BUILD_INCLUDE_DIR ${OPENCV_INSTALL_DIR}/include)
    set(OPENCV_BUILD_LIBRARY_DIR ${OPENCV_INSTALL_DIR}/lib64)
    set(OPENCV_BUILD_3RDPARTY_LIBRARY_DIR ${OPENCV_INSTALL_DIR}/share/OpenCV/3rdparty/lib64)
    set(OPENCV_LIBRARY_NAMES libopencv_imgproc.a libopencv_highgui.a libopencv_imgcodecs.a libopencv_core.a)
    set(OPENCV_3RDPARTY_LIBRARY_NAMES libIlmImf.a libittnotify.a liblibjasper.a liblibjpeg.a liblibpng.a liblibtiff.a liblibwebp.a)
endif()

foreach(LIBRARY_NAME ${OPENCV_LIBRARY_NAMES})
    list(APPEND OPENCV_STATIC_LIBRARIES ${OPENCV_LIBRARY_DIR}/${LIBRARY_NAME})
    list(APPEND OPENCV_BUILD_STATIC_LIBRARIES ${OPENCV_BUILD_LIBRARY_DIR}/${LIBRARY_NAME})
endforeach()

foreach(LIBRARY_NAME ${OPENCV_3RDPARTY_LIBRARY_NAMES})
    list(APPEND OPENCV_STATIC_LIBRARIES ${OPENCV_LIBRARY_DIR}/${LIBRARY_NAME})
    list(APPEND OPENCV_BUILD_STATIC_LIBRARIES ${OPENCV_BUILD_3RDPARTY_LIBRARY_DIR}/${LIBRARY_NAME})
endforeach()


if (BUILD_THIRD_PARTY)

ExternalProject_Add(opencv
    PREFIX opencv
    GIT_REPOSITORY ${OPENCV_URL}
    GIT_TAG ${OPENCV_TAG}
    UPDATE_COMMAND ""
    PATCH_COMMAND cmake -E make_directory ${CMAKE_CURRENT_BINARY_DIR}/opencv/src/opencv/build
    BUILD_IN_SOURCE 0
    SOURCE_DIR ${CMAKE_CURRENT_BINARY_DIR}/opencv/src/opencv
    BINARY_DIR ${CMAKE_CURRENT_BINARY_DIR}/opencv/src/opencv/build
    CMAKE_CACHE_ARGS
        -DCMAKE_BUILD_TYPE:STRING=${CMAKE_BUILD_TYPE}
        -DCMAKE_INSTALL_PREFIX:STRING=${OPENCV_INSTALL_DIR}
        -DCMAKE_VERBOSE_MAKEFILE:BOOL=OFF
        -DCMAKE_POSITION_INDEPENDENT_CODE:BOOL=ON
        -DCMAKE_CXX_FLAGS_DEBUG:STRING=${CMAKE_CXX_FLAGS_DEBUG}
        -DWITH_IPP:BOOL=OFF
        -DWITH_1394:BOOL=OFF
        -DWITH_AVFOUNDATION:BOOL=OFF
        -DWITH_CAROTENE:BOOL=OFF
        -DWITH_CPUFEATURES:BOOL=OFF
        -DWITH_VTK:BOOL=OFF
        -DWITH_CUDA:BOOL=OFF
        -DWITH_CUFFT:BOOL=OFF
        -DWITH_CUBLAS:BOOL=OFF
        -DWITH_NVCUVID:BOOL=OFF
        -DWITH_EIGEN:BOOL=OFF
        -DWITH_VFW:BOOL=OFF
        -DWITH_FFMPEG:BOOL=OFF
        -DWITH_GSTREAMER:BOOL=OFF
        -DWITH_GSTREAMER_0_10:BOOL=OFF
        -DWITH_GTK:BOOL=OFF
        -DWITH_GTK_2_X:BOOL=OFF
        -DWITH_WIN32UI:BOOL=OFF
        -DWITH_PTHREADS_PF:BOOL=OFF
        -DWITH_DSHOW:BOOL=OFF
        -DWITH_OPENCL:BOOL=OFF
        -DWITH_OPENCL_SVM:BOOL=OFF
        -DWITH_OPENCLAMDFFT:BOOL=OFF
        -DWITH_OPENCLAMDBLAS:BOOL=OFF
        -DWITH_DIRECTX:BOOL=OFF
        -DWITH_MATLAB:BOOL=OFF
        -DWITH_GPHOTO2:BOOL=OFF
        -DWITH_LAPACK:BOOL=OFF
        -DBUILD_SHARED_LIBS:BOOL=OFF
        -DBUILD_ANDROID_EXAMPLES:BOOL=OFF
        -DBUILD_DOCS:BOOL=OFF
        -DBUILD_PACKAGE:BOOL=OFF
        -DBUILD_PERF_TESTS:BOOL=OFF
        -DBUILD_TESTS:BOOL=OFF
        -DBUILD_FAT_JAVA_LIBS:BOOL=OFF
        -DBUILD_ANDROID_SERVICE:BOOL=OFF
        -DBUILD_CUDA_STUBS:BOOL=OFF
        -DENABLE_PYLINT:BOOL=OFF
        -DBUILD_opencv_python3:BOOL=OFF
        -DBUILD_opencv_python2:BOOL=OFF
        -DBUILD_opencv_world:BOOL=OFF
        -DBUILD_opencv_apps:BOOL=OFF
        -DBUILD_opencv_js:BOOL=OFF
        -DBUILD_ZLIB:BOOL=ON
        -DBUILD_TIFF:BOOL=ON
        -DBUILD_JASPER:BOOL=ON
        -DBUILD_JPEG:BOOL=ON
        -DBUILD_PNG:BOOL=ON
        -DBUILD_OPENEXR:BOOL=ON
        -DBUILD_TBB:BOOL=ON
        -DBUILD_IPP_IW:BOOL=OFF
        -DWITH_ITT:BOOL=ON
)

# put opencv includes in the 'THIRD_PARTY_DIR'
add_custom_target(opencv_create_header_dir
  COMMAND ${CMAKE_COMMAND} -E make_directory ${OPENCV_INCLUDE_DIR}
  DEPENDS opencv)

add_custom_target(opencv_copy_headers_to_destination
  COMMAND ${CMAKE_COMMAND} -E copy_directory ${OPENCV_BUILD_INCLUDE_DIR} ${OPENCV_INCLUDE_DIR}
  DEPENDS opencv_create_header_dir)

# put opencv librarys in the 'THIRD_PARTY_DIR'
add_custom_target(opencv_create_library_dir
  COMMAND ${CMAKE_COMMAND} -E make_directory ${OPENCV_LIBRARY_DIR}
  DEPENDS opencv)

add_custom_target(opencv_copy_libs_to_destination
  COMMAND ${CMAKE_COMMAND} -E copy_if_different ${OPENCV_BUILD_STATIC_LIBRARIES} ${OPENCV_LIBRARY_DIR}
  DEPENDS opencv_create_library_dir)

endif(BUILD_THIRD_PARTY)
