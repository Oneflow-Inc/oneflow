include(ExternalProject)

find_package(Threads)

set(TRT_FLASH_ATTENTION_PROJECT trt_flash_attention)

set(TRT_FLASH_ATTENTION_URL
    https://github.com/Oneflow-Inc/trt_flash_attention/archive/d8b74631eb811c95a0d20f247238db6e91acafe3.zip
)
use_mirror(VARIABLE TRT_FLASH_ATTENTION_URL URL ${TRT_FLASH_ATTENTION_URL})
set(TRT_FLASH_ATTENTION_MD5 9e0e822ce1450e11515533fbe32e58a9)

set(TRT_FLASH_ATTENTION_INSTALL_DIR ${THIRD_PARTY_DIR}/trt_flash_attention)
set(TRT_FLASH_ATTENTION_INCLUDE_DIR ${TRT_FLASH_ATTENTION_INSTALL_DIR}/include CACHE PATH "" FORCE)
set(TRT_FLASH_ATTENTION_LIBRARY_DIR ${TRT_FLASH_ATTENTION_INSTALL_DIR}/lib CACHE PATH "" FORCE)
set(TRT_FLASH_ATTENTION_LIBRARIES ${TRT_FLASH_ATTENTION_LIBRARY_DIR}/libtrt_flash_attention.so)

if(THIRD_PARTY)
  ExternalProject_Add(
    ${TRT_FLASH_ATTENTION_PROJECT}
    PREFIX trt_flash_attention
    URL ${TRT_FLASH_ATTENTION_URL}
    URL_MD5 ${TRT_FLASH_ATTENTION_MD5}
    UPDATE_COMMAND ""
    BUILD_BYPRODUCTS ${TRT_FLASH_ATTENTION_LIBRARIES}
    CMAKE_ARGS -DCMAKE_BUILD_TYPE:STRING=${CMAKE_BUILD_TYPE}
               -DCMAKE_CXX_FLAGS:STRING=${CMAKE_CXX_FLAGS}
               -DCMAKE_CXX_FLAGS_DEBUG:STRING=${CMAKE_CXX_FLAGS_DEBUG}
               -DCMAKE_CXX_FLAGS_RELEASE:STRING=${CMAKE_CXX_FLAGS_RELEASE}
    CMAKE_CACHE_ARGS
      -DCMAKE_CUDA_COMPILER:STRING=${CUDAToolkit_NVCC_EXECUTABLE}
      -DCMAKE_C_COMPILER_LAUNCHER:STRING=${CMAKE_C_COMPILER_LAUNCHER}
      -DCMAKE_CXX_COMPILER_LAUNCHER:STRING=${CMAKE_CXX_COMPILER_LAUNCHER}
      -DCMAKE_INSTALL_PREFIX:PATH=${TRT_FLASH_ATTENTION_INSTALL_DIR}
      -DCMAKE_INSTALL_LIBDIR:PATH=${TRT_FLASH_ATTENTION_LIBRARY_DIR}
      -DCMAKE_INSTALL_MESSAGE:STRING=${CMAKE_INSTALL_MESSAGE}
      -DCMAKE_BUILD_TYPE:STRING=${CMAKE_BUILD_TYPE})
endif(THIRD_PARTY)
