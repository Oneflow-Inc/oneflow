include(ExternalProject)

find_package(Threads)

set(CUTLASS_PROJECT cutlass)

set(CUTLASS_INSTALL_DIR ${THIRD_PARTY_DIR}/cutlass)

set(CUTLASS_INCLUDE_DIR ${CUTLASS_INSTALL_DIR}/include CACHE PATH "" FORCE)
set(CUTLASS_LIBRARY_DIR ${CUTLASS_INSTALL_DIR}/lib CACHE PATH "" FORCE)
set(CUTLASS_LIBRARIES ${CUTLASS_LIBRARY_DIR}/libcutlass.so)
set(CUTLASS_SOUREC_DIR ${CMAKE_CURRENT_BINARY_DIR}/cutlass/src/cutlass/)

if(THIRD_PARTY)
  ExternalProject_Add(
    ${CUTLASS_PROJECT}
    PREFIX cutlass
    URL ${CUTLASS_URL}
    URL_MD5 ${CUTLASS_MD5}
    UPDATE_COMMAND ""
    BUILD_BYPRODUCTS ${CUTLASS_LIBRARIES}
    CMAKE_ARGS -DCMAKE_BUILD_TYPE:STRING=${CMAKE_BUILD_TYPE}
               -DBUILD_SHARED_LIBS:BOOL=OFF
               -DCMAKE_CXX_FLAGS:STRING=${CMAKE_CXX_FLAGS}
               -DCMAKE_CXX_FLAGS_DEBUG:STRING=${CMAKE_CXX_FLAGS_DEBUG}
               -DCMAKE_CXX_FLAGS_RELEASE:STRING=${CMAKE_CXX_FLAGS_RELEASE}
    CMAKE_CACHE_ARGS
      -DCMAKE_C_COMPILER_LAUNCHER:STRING=${CMAKE_C_COMPILER_LAUNCHER}
      -DCMAKE_CXX_COMPILER_LAUNCHER:STRING=${CMAKE_CXX_COMPILER_LAUNCHER}
      -DCMAKE_INSTALL_PREFIX:PATH=${CUTLASS_INSTALL_DIR}
      -DCMAKE_INSTALL_LIBDIR:PATH=${CUTLASS_LIBRARY_DIR}
      -DCMAKE_INSTALL_MESSAGE:STRING=${CMAKE_INSTALL_MESSAGE}
      -DCMAKE_BUILD_TYPE:STRING=${CMAKE_BUILD_TYPE}
      -DCUTLASS_LIBRARY_OPERATIONS:STRING=conv2d
      -DCUTLASS_LIBRARY_KERNELS:STRING=fprop
      -DCUTLASS_ENABLE_EXAMPLES:BOOL=OFF
      -DCUTLASS_ENABLE_PROFILER:BOOL=OFF
      -DCUTLASS_ENABLE_LIBRARY:BOOL=ON
      -DCUTLASS_NVCC_ARCHS:STRING=80
      -DCUTLASS_ENABLE_TESTS:BOOL=OFF
      )

add_custom_target(cutlass_copy_examples_to_destination DEPENDS cutlass)
set(CUTLASS_SOURCE_EXAMPLES_DIR ${CUTLASS_SOUREC_DIR}/examples)
file(GLOB_RECURSE examples_files RELATIVE ${CUTLASS_SOURCE_EXAMPLES_DIR} ${CUTLASS_SOURCE_EXAMPLES_DIR}/*)
foreach(filename ${examples_files} )
    add_custom_command(TARGET cutlass_copy_examples_to_destination
	    COMMAND ${CMAKE_COMMAND} -E copy_if_different ${CUTLASS_SOURCE_EXAMPLES_DIR}/${filename} ${CUTLASS_INSTALL_DIR}/examples/${filename})
endforeach()

endif(THIRD_PARTY)
